# inkfish
A forward proxy for machines, with access control lists

[![Build Status](https://travis-ci.org/bsycorp/inkfish.svg?branch=master)](https://travis-ci.org/bsycorp/inkfish)

https://hub.docker.com/r/bsycorp/inkfish

## Command-line arguments

```
$ ./inkfish -h
Usage of ./inkfish:
  -addr string
    	proxy listen address (default ":8080")
  -cacert string
    	path to CA cert file (default "ca.pem")
  -cakey string
    	path to CA key file (default "ca.key.pem")
  -config string
    	path to configuration files (default ".")
  -metadata string
    	default metadata provider (aws,none) (default "aws")
  -v	should every proxy request be logged to stdout
```

## Configuration file format

The `-config` argument supplies a path to a directory full of "access control lists" and password file
entries. 

### Passwd files

Passwd files in the config directory must have a `.passwd` extension. They may contain one or more 
lines of: `<username>:<sha256-of-password>` and will be used to verify proxy auth.

It is expected that passwords will generated by infracode / orchestration and have high entropy so
a heavyweight password hashing function is not required.

### ACL Files

ACL files in the config directory must have a `.conf` extension. These control what requests will 
be allowed through the proxy. The general format looks like:

```
from <user> [user2 user3...]
from ...
acl [METHOD,METHOD2] <url-regex>
acl ...
```

Blank lines and comments (lines starting with `#`) are ignored. The "from" lines gate entry into the ACL.
The <user> may be specified as:

* `user:foo` - Identifies a client who will supply a proxy-authorization header with a username of `foo`.
* `tag:foo` - Identifies a client whose cloud metadata (e.g. instance ProxyUser tag in AWS) is `foo`.
* `ANONYMOUS` - Identifies a user or system which does not supply a proxy-authorization header and 
               does not have any identifying metadata tags.

## Metadata lookup

Rather than distributing proxy credentials, the preferred method of access control in inkfish is via
cloud instance metadata. 

### AWS

For AWS, specify the `ProxyUser` tag on an instance. So for example if you apply tag of ProxyUser=foo,
then in your ACL you would write:

```
from tag:foo
acl ^http(s)?://.*$
```

To grant instances with that tag unrestricted outbound HTTP(s) access.

## MITM, SSL certificates and Security

By default, Inkfish's HTTP client will perform SSL/TLS certificate validation on all forwarded requests. A
good way to test this is working properly is to start the proxy locally and visit https://badssl.com/dashboard/

There are a variety of strategies that MITM proxies can use to create acceptable certificates for clients.

Some proxies "sneak and peek", attempting to mirror the origin server's certificate as closely as possible,
with the exception of the signing CA. 

This is not one of those proxies.  Inkfish inherits the goproxy strategy of looking at the client's CONNECT 
target and just generating a cert with that in it. 

## Known issues / TODO

* Generated certs for sites expire in 2049(!)
* Potential file descriptor leak on SSL connections.
* Graceful shutdown / draining not tested


